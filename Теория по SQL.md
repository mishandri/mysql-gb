# Основы SQL

## 01. Общие команды mysql

### Подключение

Подключение к mysql на самом сервере. Параметр u отвечает за имя пользователя, p - запрос пароль.

```bash
mysql -u root -p
```

Подключение к mysql с другого компьютера. Параметр h указывает сервер, P - порт.

```bash
mysql -u root -h 192.168.1.36-P 3306-p
```

### Команды mysql

```sql
USE     \u  -- Выбор БД
SOURCE  \.  -- Выполнение SQL-команд из файла
SYSTEM  \!  -- Выполнение команды ОС
STATUS  \s  -- Вывод имнформации о состоянии сервера
EXIT    \q  -- выход
	\G  -- Вывод информации в вертикальном формате. Только для самого клиента mysql, а не других программ
```

### Создание дампа для бэкапа

```bash
mysqldump -u root -p mysql > mysql.sql
```

### Восстановление дампа

```bash
mysql -u root -p mysql 
mysql -u root -p sample D:\example.sql
mysql -u root -p sample < example.sql
```

Чтобы не вводить каждый раз пользователя и пароль, можно создать файл `.my.cnf` в папке запуска (дамашней папке)

### Настройка подключения

Для подключения самого mysql:

```plaintext
[mysql]
user=root
password=1234
```

Если хочешь оставить пароль внутри, то надо ограничить доступ, оставить только для текущего пользователя: `chmod 0600 ~/.my.cnf`

Для подключения всех клиентов:

```plaintext
[client]
user=root
password=1234
-- C:\Windows
```

### Основные команды с БД

Просмотр всех БД

```sql
SHOW DATABASES;
```

Создание БД

```sql
CREATE DATABASE shop;
```

Создание БД с проверкой на существование

```sql
CREATE DATABASE IF NOT EXISTS shop;
```

Каталог данных

```sql
SHOW VARIABLES LIKE'datadir';
```

Удаление БД

```sql
DROP DATABASE shop;
```

Удаление БД с проверкой на существование

```sql
DROP DATABASE IF EXISTS shop;
```

Выбрать БД по умолчанию

```sql
USE shop
```

Можно не указывать USE, но тогда нужно всегда писать FROM

```sql
SHOW TABLES FROM shop
```

Подключиться сразу к БД

```bash
mysql shop
```

### Основные команды с таблицами

Создание таблиц

```sql
CREATE TABLE users (k INT);
```

Показать все таблицы в БД

```sql
SHOW TABLES;
```

Подробный вывод для конкретной таблицы

```sql
DESCRIBE user;
```

Подробный вывод для интересующего столбца таблицы

```sql
DESCRIBE user 'User';
```

Подробный вывод столбцов таблицы, начинающихся на m

```sql
DESCRIBE user 'm%';
```

*Примечание: SHOW и DESCRIBE являются не стандартными, другие БД их могут не иметь.*

Поэтому всегда можно воспользоваться стандартными средствами:

```sql
SELECT * FROM information_schema.SCHEMA; --information_schema - виртуальная БД
```

Вывод таблицы

```sql
SELECT * FROM information_schema.TABLESWHERE TABLE_SCHEMA ='shop'\G; -- \G только в mysql
```

## 02. Язык SQL

SQL - Structured Query Language

### Достоинства SQL

* Декларативый язык. Описываем цель, а не инструкцию алгоритма;
* Высокоуровнева структура, напоминающая естественный язык;
* Высокая эффективность обработки множеств;
* Независимость от конкретных СУБД;
* Межплатформенная переносимость;
* Наличие стандартов.

### Недостатки SQL

* Слабоструктурированный язык;
* Старый язык. С современной точки зрения он не очень удобен;
* Плохое взаимодействие с ООП-языками;
* Не универсальный язык. Нельзя создать независимую программу;
* Множество диалектов.

### Элементы языка

* Коментарии
* Скалярные выражения (константы)
* Ключевые слова
* Операторы
* Таблицы
* Столбцы
* Индексы
* Предопределенные функции
* Представления
* Переменные
* Хранимые процедуры
* Хранимые функции
* Триггеры
* Коды ошибок

### Коментарии

Однострочные

```sql
-- Это однострочный коментарий
```

Многострочные

```sql
/* Многострочный
коментарий */
```

### Инструкции

**DDL (Data Definition Language)** - язык описания данных. Инфструкции создания, редактирования и удаления БД и таблиц. Опреаторы, позволяющие воссоздать структуру БД.

**DML (Data Manipulation Language)** - язык управления данными. Инфструкции создания, редактирования, удаления и извлечения данных из таблиц. Операторы, обслуживающие данные, хранящиеся в БД.

Каждая инструкция начинается с ключевого слова, которая описывает выполняемые дейтсвия.

### Типы данных

Тип данных определяет характеристики значений и количество памяти, выделяемой под хранение.

* Числовые
* Строковые
* NULL
* Календарные
* Коллекции

Типы могут сопровождаться дополнительными атрибутами, которые задают ограничение на столбец:

* NULL (позволяет неопределенные значения) или NOT NULL (запрещает неопределенные значения)
* DEFAULT (позволяет задать значение по умолчанию)
* UNSIGNED (беззнаковое числовое поле)

**Числовые типы:**

* Целочисленные (быстрая обработка) TINYINT (1 байт), SMALLINT (2 байта), MEDIUMINT (3 байта), INT (4 байта), BIGINT (8 байт)
* Вещественные (средняя обработка) FLOAT (4 байта), DOUBLE (8 байт)
* Точные (медленная обработка) DECIMAL (зависит от объявления). DECIMAL(7,4) 7 байт под целую часть, 4 байта под дробную часть

**Строковые типы:**

* Фиксированные CHAR (40 символов по умолчанию)
* Переменные VARCHAR (ровно по количеству символов)
* BLOB-строка TINYTEXT (256 символов), TEXT (65536 символов), MEDIUMTEXT (16777216/16МБ), LONGTEXT (4294967296/4ГБ)

**Календарные типы:**

* TIME - хранение времени в течении суток
* YEAR - хранит год
* DATE - хранит дату с точностью до дня
* DATETIME - хранит дату и время
* TIMESTAMP - хранит дату и время (1970 - 2038)

| Тип    | Формат          | Кол-во байт |
| --------- | --------------------- | -------------------- |
| YEAR      | 0000                  | 1                    |
| DATE      | '0000-00-00'          | 3                    |
| TIME      | '00:00:00'            | 3                    |
| DATETIME  | '0000-00-00 00:00:00' | 4                    |
| TIMESTAMP | '0000-00-00 00:00:00' | 8                    |

**Особые типы данных**

* ENUM - поле принимает одно значение из списка
* SET - поле принимает комбинацию значений из списка
* JSON - коллекция данных (похожи на словари python)

**Индексы**

* Обычные
* Уникальные, первичный ключ
* Полнотекстовый

Создать индекс внутри таблицы:

```sql
CREATE TABLE products (
    ...
    KEY index_of_catalog_id(catalog_id);
)
```

Создать индексы в уже существующую таблицу:

```sql
CREATE INDEX index_of_catalog_id ON products(catalog_id);
```

Убрать индексы из таблицы:

```sql
DROP INDEX index_of_catalog_id ON products;
```

Индексы BTREE - индекы в виде бинарного дерева. Быстрый поиск.

```sql
CREATE INDEX index_of_catalog_id USING BTREE ON products(catalog_id);
```

Индексы HASH - только для точного поиска с указанием всех столбцов-индексов.

```sql
CREATE INDEX index_of_catalog_id USING HASH ON products(catalog_id);
```

**Псевдотип SERIAL**

SERIAL == BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE

## 03. Операции CRUD

| CRUD             | SQL    |
| ---------------- | ------ |
| **C**reate | INSERT |
| **R**ead   | SELECT |
| **U**pdate | UPDATE |
| **D**elete | DELETE |

**Создание значений**

Одиночная вставка

```sql
INSERT INTO catalogs (name) VALUES ('Процессоры');
INSERT INTO catalogs (name) VALUES ('Мат.платы');
INSERT INTO catalogs (name) VALUES ('Видеокарты');
```

Многострочная вставка

```sql
INSERT INTO catalogs VALUES
	(NULL, 'Процессоры'),
	(NULL, 'Мат.платы'),
	(NULL, 'Видеокарты');
```

Если нужно, чтобы не было повторяющихся значений в столбце, то можно сделать егшо уникальным.

```sql
CREATE TABLE catalogs (
	...
	UNIQUE unique_name(name(10))
)
```

В этом случае при добавлении уже имеющегося значения, появится ошибка. Ошибку можно игнорировать:

```sql
INSERT IGNORE INTO catalogs VALUES 
	(DEFAULT, 'Процессоры'),
	(DEFAULT, 'Мат.платы'),
	(DEFAULT, 'Видеокарты'),
	(DEFAULT, 'Видеокарты');
```

**Чтение значений**

```sql
SELECT id, name FROM catalogs;
SELECT name FROM catalogs;
SELECT * FROM catalogs;
```

**Удаление значений**

Удаление данных. Счётчик автоинкремента не обнуляется

```sql
DELETE FROM catalogs; -- удаляет все записи
DELETE FROM catalogs LIMIT 2; -- удаляет первые записи
DELETE FROM catalogs WHERE id > 1; -- удаляет записи, id которых больше 1
DELETE FROM catalogs WHERE id > 1 LIMIT 1; -- удаляет одну запись, id которой больше 1
```

Очистка всей таблицы и обнуление счётчика автоинкримента

```sql
TURNCATE catalogs;
```

**Обновление значений**

```sql
UPDATE
  catalogs
SET
  name = 'Процессоры (Intel)'
WHERE
  name = 'Процессоры'
```

**INSERT-SELECT**

```sql
INSERT INTO
  cat
SELECT
  *
FROM
  catalogs;

SELECT * FROM cat;
```
